# Переходим к MQTT

Wikipedia: *MQTT (англ. message queuing telemetry transport) — упрощённый сетевой протокол, работающий поверх TCP/IP, ориентированный для обмена сообщениями между устройствами по принципу издатель-подписчик.*
*Протокол ориентируется на простоту в использовании, невысокую нагрузку на каналы связи, работу в условиях постоянной потери связи, лёгкую встраиваемость в любую систему. Основное предназначение — работа с телеметрией от различных датчиков, устройств, использование шаблона подписчика обеспечивает возможность устройствам выходить на связь и публиковать сообщения, которые не были заранее известны или предопределены, в частности, протокол не вводит ограничений на формат передаваемых данных.*

Работает поверх протокола TCP, это обеспечивает более надежную доставку сообщений (или информацию о том, что не доставлено).
Требует установки соединения по сети, для установленного соединения используется две операции - SUBSCRIBE и PUBLISH.

Основная единица хранения информации - **топики (topic)**, которые могут быть вложены друг в друга (субтопики). В топик можно **опубликовать (PUBLISH)** любой пакет информации и он будет доставлен всем, кто **подписался (SUBSCRIBE)** на этот топик.
Подробнейшая информация - http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html - на момент публикации этой инструкции

Поверх этого механизма и будет работать наша система. Все контроллеры получают доступ к интернету по Wi-Fi, соединяются с MQTT сервером, подписываются на отдельные топики и/или публикуют в топики информацию.
Управляющий сервер также подписывается на нужные топики и может по наступлению определённых событий публиковать в топики информацию или отправлять оповещения через интернет каким-либо способом.

Для смартфона под управлением Android есть приложения:
	
**Linear MQTT Dashboard**
https://play.google.com/store/apps/details?id=com.ravendmaster.linearmqttdashboard

**MQTT Dash**
https://play.google.com/store/apps/details?id=net.routix.mqttdash

Для смартфона под управлением IOS есть приложения:

##### TODO

## Настройки

Пока две команды занимаются настройкой локального MQTT сервера, можно использовать для тестирования сервер организаторов. Реквизиты будут сообщены инструктором.

## Тест MQTT

Для начала работы с MQTT скачайте готовый скетч [00_mqtt](../00_mqtt/) и откройте его в среде Arduino IDE.

Он содержит дополнительный файл **config.h**, который содержит в себе основные настройки. Приведите его в соответствие с указанными инструктором.

Для каждой команды параметры mqtt_topic_* должны быть дополнены еще и номером команды, чтобы команды не мешали друг другу. Указан пример для первой команды.

#define mqtt_topic_heartbeat	"esp8266**/1/**heartbeat"
#define mqtt_topic_in 		"esp8266**/1/**led1"
#define mqtt_topic_out 		"esp8266**/1/**status"

После заливки в контроллер Вы сможете, направляя 1 или 0 в топик, указанный в **mqtt_topic_in**, управлять со своего компьютера, мобильного телефона или через WEB поведением светодиода. При этом в топике, указанном в **mqtt_topic_heartbeat** будут периодически появляться сообщения от контроллера, что он на связи, а в **mqtt_topic_out** будет дополнительно публиковаться текущее состояние светодиода.